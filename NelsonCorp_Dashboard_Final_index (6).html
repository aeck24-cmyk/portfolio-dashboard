<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Portfolio Performance â€” NelsonCorp Wealth Management</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --green:        #2d6a4f;
    --green-dark:   #1b4332;
    --green-mid:    #40916c;
    --green-light:  #d8f3dc;
    --green-xlight: #f0faf2;
    --gold:         #c9a84c;
    --gold-light:   #f0d080;
    --gold-xlight:  #fdf8ec;
    --white:        #ffffff;
    --off-white:    #f8f9f7;
    --light-gray:   #eef0eb;
    --mid-gray:     #c4cbbf;
    --border:       #dde5d8;
    --text-dark:    #1b2e1f;
    --text-mid:     #3d5240;
    --text-light:   #7a917e;
    --pos:          #1a6b3c;
    --neg:          #b83232;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Source Sans 3', sans-serif; font-size: 16px; background: var(--off-white); color: var(--text-dark); min-height: 100vh; }

  /* HEADER */
  .site-header { background: var(--green-dark); padding: 0 44px; display: flex; align-items: center; justify-content: space-between; height: 78px; border-bottom: 4px solid var(--gold); flex-wrap: wrap; gap: 10px; }
  .logo-area { display: flex; align-items: center; gap: 16px; }
  .logo-img { height: 46px; object-fit: contain; filter: brightness(0) invert(1); }
  .logo-divider { width: 1px; height: 34px; background: rgba(255,255,255,0.2); }
  .logo-sub { font-size: 0.85rem; color: rgba(255,255,255,0.55); letter-spacing: 0.1em; text-transform: uppercase; }
  .header-date { font-size: 0.88rem; color: rgba(255,255,255,0.5); }

  /* TITLE BAR */
  .title-bar { background: var(--green); padding: 20px 44px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
  .title-bar h1 { font-family: 'Merriweather', serif; font-size: 1.45rem; font-weight: 400; color: var(--white); }
  .title-bar h1 span { color: var(--gold-light); }
  .title-meta { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
  .update-info { font-size: 0.82rem; color: rgba(255,255,255,0.55); }
  .status-badge { display: flex; align-items: center; gap: 7px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.15); padding: 5px 13px; border-radius: 20px; font-size: 0.78rem; color: rgba(255,255,255,0.65); letter-spacing: 0.04em; }
  .sdot { width: 7px; height: 7px; border-radius: 50%; background: var(--mid-gray); flex-shrink: 0; }
  .sdot.live    { background: #52d68a; animation: pulse 2.5s ease-in-out infinite; }
  .sdot.loading { background: var(--gold); }
  .sdot.error   { background: #e06060; }
  @keyframes pulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(82,214,138,0.4)} 50%{opacity:.8;box-shadow:0 0 0 5px rgba(82,214,138,0)} }

  /* MAIN */
  .main { max-width: 1380px; margin: 0 auto; padding: 36px 44px 70px; }

  /* SPINNER (used in loading banner) */
  .spinner { width: 42px; height: 42px; border: 3px solid var(--light-gray); border-top-color: var(--green-mid); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* DASHBOARD */
  #dashboard { display: none; animation: fadeUp 0.4s ease; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

  .dash-controls { display: flex; align-items: center; gap: 14px; margin-bottom: 28px; flex-wrap: wrap; justify-content: space-between; }
  .dash-controls-left { display: flex; gap: 12px; align-items: center; }
  .dash-source { font-size: 0.78rem; color: var(--text-light); }

  /* BUTTONS */
  .btn-green { background: var(--green-dark); color: var(--white); border: none; font-family: 'Source Sans 3', sans-serif; font-size: 0.88rem; font-weight: 600; padding: 10px 22px; border-radius: 5px; cursor: pointer; transition: background 0.2s; }
  .btn-green:hover { background: var(--green); }
  .btn-outline { background: var(--white); border: 1.5px solid var(--border); color: var(--text-mid); font-family: 'Source Sans 3', sans-serif; font-size: 0.88rem; font-weight: 600; padding: 9px 20px; border-radius: 5px; cursor: pointer; transition: all 0.2s; }
  .btn-outline:hover { border-color: var(--green); color: var(--green); background: var(--green-xlight); }

  /* SECTION */
  .section-header { display: flex; align-items: center; gap: 14px; margin-bottom: 18px; margin-top: 36px; }
  .section-header:first-child { margin-top: 0; }
  .section-title { font-family: 'Merriweather', serif; font-size: 1.05rem; font-weight: 700; color: var(--green-dark); white-space: nowrap; }
  .section-rule { flex: 1; height: 1px; background: var(--border); }
  .section-tag { font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-light); background: var(--light-gray); padding: 4px 11px; border-radius: 20px; white-space: nowrap; }

  /* CARDS */
  .cards-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(195px, 1fr)); gap: 16px; margin-bottom: 8px; }
  .card { background: var(--white); border: 1px solid var(--border); border-radius: 6px; padding: 18px 20px 16px; position: relative; box-shadow: 0 1px 5px rgba(0,0,0,0.05); transition: box-shadow 0.2s, transform 0.2s; }
  .card:hover { box-shadow: 0 5px 16px rgba(0,0,0,0.1); transform: translateY(-1px); }
  .card-accent { position: absolute; top: 0; left: 0; right: 0; height: 4px; border-radius: 6px 6px 0 0; background: var(--mid-gray); }
  .card.bench   .card-accent { background: var(--green-mid); }
  .card.positive .card-accent { background: var(--pos); }
  .card.negative .card-accent { background: var(--neg); }
  .card-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.09em; color: var(--text-light); margin-bottom: 10px; }
  .card-value { font-family: 'Merriweather', serif; font-size: 1.75rem; font-weight: 700; line-height: 1; }
  .card-value.pos { color: var(--pos); }
  .card-value.neg { color: var(--neg); }
  .card-value.neu { color: var(--text-dark); }
  .card-type { font-size: 0.75rem; color: var(--text-light); margin-top: 5px; }
  .card-divider { height: 1px; background: var(--light-gray); margin: 12px 0; }
  .card-row { display: flex; justify-content: space-between; font-size: 0.84rem; color: var(--text-light); margin-top: 5px; }
  .card-row .val { font-weight: 700; }
  .card-row .val.pos { color: var(--pos); }
  .card-row .val.neg { color: var(--neg); }
  .card-row .val.neu { color: var(--text-dark); }

  /* CHART */
  .chart-card { background: var(--white); border: 1px solid var(--border); border-radius: 6px; padding: 26px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); }
  .chart-card canvas { max-height: 270px; }

  /* PANELS */
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 22px; }
  @media(max-width: 960px) { .two-col { grid-template-columns: 1fr; } }
  .panel { background: var(--white); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; box-shadow: 0 1px 5px rgba(0,0,0,0.05); }
  .panel-header { background: var(--green-dark); padding: 14px 20px; display: flex; justify-content: space-between; align-items: center; gap: 12px; border-bottom: 2px solid var(--gold); }
  .panel-title { font-family: 'Merriweather', serif; font-size: 0.95rem; font-weight: 400; color: var(--white); }
  .panel-return { font-weight: 700; padding: 3px 11px; border-radius: 4px; font-size: 0.88rem; }
  .panel-return.pos { background: rgba(26,107,60,0.3); color: #90dfb0; }
  .panel-return.neg { background: rgba(184,50,50,0.3); color: #f5a0a0; }
  .panel-return.neu { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); }
  .panel-bench { font-size: 0.78rem; color: rgba(255,255,255,0.5); }
  .panel-bench .pos { color: #90dfb0; font-weight: 700; }
  .panel-bench .neg { color: #f5a0a0; font-weight: 700; }
  table { width: 100%; border-collapse: collapse; }
  thead { background: var(--green-xlight); }
  th { font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.09em; color: var(--green-dark); padding: 11px 18px; text-align: right; border-bottom: 2px solid var(--border); }
  th:first-child { text-align: left; }
  td { font-size: 0.9rem; padding: 11px 18px; text-align: right; border-bottom: 1px solid var(--light-gray); color: var(--text-mid); }
  td:first-child { text-align: left; color: var(--text-dark); font-weight: 600; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--green-xlight); }
  td.pos { color: var(--pos); font-weight: 700; }
  td.neg { color: var(--neg); font-weight: 700; }
  .total-row td { background: var(--green-light) !important; font-weight: 700; border-top: 2px solid var(--border); border-bottom: none !important; color: var(--green-dark); }
  .total-row td.pos { color: var(--pos); }
  .total-row td.neg { color: var(--neg); }
  .ticker-tag { display: inline-block; background: var(--green-dark); color: var(--white); font-size: 0.75rem; font-weight: 700; letter-spacing: 0.06em; padding: 2px 8px; border-radius: 3px; }

  /* HOLDINGS SELECTOR */
  .holdings-selector-row { display: flex; align-items: center; gap: 14px; margin-bottom: 20px; flex-wrap: wrap; }
  .holdings-select {
    font-family: 'Source Sans 3', sans-serif; font-size: 0.92rem; font-weight: 600;
    color: var(--text-dark); background: var(--white);
    border: 1.5px solid var(--border); border-radius: 5px;
    padding: 9px 36px 9px 14px; cursor: pointer;
    appearance: none; -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237a917e' stroke-width='1.8' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 12px center;
    min-width: 220px; transition: border-color 0.2s, box-shadow 0.2s;
  }
  .holdings-select:hover { border-color: var(--green); }
  .holdings-select:focus { outline: none; border-color: var(--green); box-shadow: 0 0 0 3px rgba(45,106,79,0.12); }
  .holdings-panel-wrap { animation: fadeUp 0.25s ease; }

  /* FOOTER */
  .site-footer { background: var(--green-dark); border-top: 3px solid var(--gold); padding: 22px 44px; text-align: center; font-size: 0.75rem; color: rgba(255,255,255,0.35); line-height: 1.9; margin-top: 60px; }
</style>
</head>
<body>

<div class="site-header">
  <div class="logo-area">
    <img src="https://nelsoncorp.com/wp-content/uploads/2025/06/NelsonCorp-Logo-2025.png" alt="NelsonCorp" class="logo-img" onerror="this.style.display='none';document.querySelector('.logo-fallback').style.display='block'">
    <div class="logo-fallback" style="display:none;font-family:'Merriweather',serif;color:#fff;font-size:1.1rem;font-weight:700">NelsonCorp Wealth Management</div>
    <div class="logo-divider"></div>
    <div class="logo-sub">Portfolio Analytics</div>
  </div>
  <div class="header-date" id="header-date"></div>
</div>

<div class="title-bar">
  <h1>Daily Portfolio <span>Performance Dashboard</span></h1>
  <div class="title-meta">
    <div class="status-badge"><span class="sdot loading" id="sdot"></span><span id="stext">Connecting...</span></div>
    <div class="update-info" id="update-info"></div>
  </div>
</div>

<div class="main">

  <!-- PRICE LOADING BANNER -->
  <div id="price-loading-banner" style="background:var(--green-xlight);border:1px solid var(--border);border-radius:6px;padding:12px 20px;margin-bottom:20px;display:flex;align-items:center;gap:10px;font-size:0.85rem;color:var(--text-mid);">
    <div class="spinner" style="width:18px;height:18px;border-width:2px;margin:0;flex-shrink:0;"></div>
    <span>Fetching live ETF prices from Yahoo Finance...</span>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard">
    <div class="dash-controls">
      <div class="dash-controls-left">
        <button class="btn-outline" onclick="fetchLivePrices()">â†» Refresh Prices</button>
        <label class="btn-outline" style="font-size:0.8rem;padding:8px 14px;cursor:pointer;">
          ðŸ“‚ Upload Model Data
          <input type="file" id="file-input2" accept=".xlsx,.xls" style="display:none">
        </label>
      </div>
      <div class="dash-source" id="dash-source"></div>
    </div>

    <div class="section-header">
      <div class="section-title">Market Benchmarks</div>
      <div class="section-rule"></div>
      <div class="section-tag">Daily Â· YTD</div>
    </div>
    <div class="cards-row" id="bench-cards"></div>

    <div class="section-header">
      <div class="section-title">Portfolio Models</div>
      <div class="section-rule"></div>
      <div class="section-tag">Daily Â· YTD Â· vs Benchmark</div>
    </div>
    <div class="cards-row" id="model-cards"></div>

    <div class="section-header">
      <div class="section-title">Performance Comparison</div>
      <div class="section-rule"></div>
    </div>
    <div class="chart-card" style="margin-bottom:8px">
      <canvas id="perf-chart"></canvas>
    </div>

    <div class="section-header">
      <div class="section-title">Holdings Detail</div>
      <div class="section-rule"></div>
    </div>
    <div class="holdings-selector-row">
      <select class="holdings-select" id="holdings-select" onchange="showSelectedPortfolio()">
        <option value="">â€” Select a portfolio â€”</option>
      </select>
    </div>
    <div id="holdings-panels"></div>
  </div>

</div>

<div class="site-footer">
  NelsonCorp Wealth Management &nbsp;Â·&nbsp; Internal Use Only &nbsp;Â·&nbsp; 880 13th Avenue North, Clinton, Iowa 52732<br>
  Securities offered through Registered Representatives of Cambridge Investment Research, Inc., a broker-dealer, member FINRA/SIPC.
  Advisory services through Cambridge Investment Research Advisors, Inc., a Registered Investment Advisor.
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HYBRID DASHBOARD
//   â€¢ Benchmark ETF prices  â†’ Yahoo Finance (auto, every 1 min)
//   â€¢ Portfolio model data  â†’ Manual Excel upload
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Benchmark tickers: { display name, ticker }
const BENCHMARKS = [
  { name: 'S&P 500',         ticker: 'VOO'  },
  { name: 'Dow Jones',       ticker: 'DIA'  },
  { name: 'Nasdaq 100',      ticker: 'QQQ'  },
  { name: 'Russell 2000',    ticker: 'IWM'  },
  { name: 'U.S. Bonds',      ticker: 'AGG'  },
  { name: 'U.S. Dollar',     ticker: 'UUP'  },
  { name: 'Gold',            ticker: 'IAU'  },
  { name: 'Oil',             ticker: 'USO'  },
];

const PRICE_REFRESH_MS = 60 * 1000; // every 1 minute
const YAHOO_PROXY = 'https://api.allorigins.win/raw?url=';

let chartInstance   = null;
let priceTimer      = null;
let liveprices      = {};   // ticker â†’ { daily, ytd }
let modelData       = [];   // from uploaded Excel
let holdingsData    = [];   // from uploaded Excel

// â”€â”€ INIT â”€â”€
document.getElementById('header-date').textContent = new Date().toLocaleDateString('en-US', {
  weekday:'long', year:'numeric', month:'long', day:'numeric'
});

window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('dashboard').style.display = 'block';
  fetchLivePrices();
});

// â”€â”€ LIVE PRICE FETCH â”€â”€
async function fetchLivePrices() {
  const banner = document.getElementById('price-loading-banner');
  if (banner) banner.style.display = 'flex';
  setStatus('loading', 'Fetching prices...');

  const tickers = BENCHMARKS.map(b => b.ticker).join(',');
  const yahooUrl = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${tickers}&fields=regularMarketPrice,regularMarketPreviousClose,regularMarketChangePercent`;
  const proxyUrl = YAHOO_PROXY + encodeURIComponent(yahooUrl);

  try {
    const res  = await fetch(proxyUrl);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    const quotes = json?.quoteResponse?.result || [];

    liveprices = {};
    quotes.forEach(q => {
      const daily = q.regularMarketChangePercent / 100;
      liveprices[q.symbol] = { daily, ytd: null };
    });

    if (banner) banner.style.display = 'none';
    setStatus('live', 'Live Â· Yahoo Finance');
    document.getElementById('update-info').textContent =
      'Prices updated ' + new Date().toLocaleTimeString('en-US', { timeStyle:'short' });
    document.getElementById('dash-source').textContent =
      'â†» Prices auto-refresh every minute Â· Model data: ' +
      (modelData.length ? 'uploaded' : 'upload Excel to populate');

    renderBenchSection();
    renderChartCombined();

    clearInterval(priceTimer);
    priceTimer = setInterval(fetchLivePrices, PRICE_REFRESH_MS);

  } catch (err) {
    if (banner) banner.style.display = 'none';
    setStatus('error', 'Price fetch failed');
    document.getElementById('update-info').textContent = 'Could not reach Yahoo Finance â€” check connection';
    console.error('Yahoo Finance fetch error:', err);
  }
}

// â”€â”€ EXCEL FILE UPLOAD â”€â”€
document.getElementById('file-input2').addEventListener('change', e => handleFile(e.target.files[0]));

function handleFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => processWorkbook(e.target.result, file.name);
  reader.readAsArrayBuffer(file);
}

function processWorkbook(buffer, source) {
  const wb = XLSX.read(buffer, { type: 'array' });
  const sheets = {};
  wb.SheetNames.forEach(n => {
    sheets[n] = XLSX.utils.sheet_to_json(wb.Sheets[n], { header:1, defval:'' });
  });

  const dashData = parseDashboard(sheets['Dashboard'] || []);
  modelData   = dashData.filter(d => d.dailyBench !== null);
  holdingsData = parseHoldings(sheets['NelsonCorp'] || []);

  document.getElementById('dash-source').textContent =
    'â†» Prices auto-refresh every minute Â· Model data: ' + source;
  document.getElementById('update-info').textContent =
    'Model data loaded ' + new Date().toLocaleTimeString('en-US', { timeStyle:'short' });

  renderModelCards(modelData);
  renderHoldings(holdingsData);
  renderChartCombined();
}

// â”€â”€ STATUS â”€â”€
function setStatus(state, text) {
  document.getElementById('sdot').className = 'sdot ' + state;
  document.getElementById('stext').textContent = text;
}

// â”€â”€ HELPERS â”€â”€
function fmt(val, dec = 2) {
  if (val === '' || val == null || isNaN(val)) return 'â€”';
  const p = val * 100;
  return (p > 0 ? '+' : '') + p.toFixed(dec) + '%';
}
function cc(val) {
  if (val == null || val === '' || isNaN(val)) return 'neu';
  return val > 0 ? 'pos' : val < 0 ? 'neg' : 'neu';
}

// â”€â”€ PARSE â”€â”€
function parseDashboard(rows) {
  const out = [];
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    if (!r[0] || r[0] === 'Model') continue;
    out.push({
      model:      String(r[0]),
      daily:      parseFloat(r[2]),
      dailyBench: (r[3] !== '' && r[3] != null && !isNaN(r[3])) ? parseFloat(r[3]) : null,
      ytd:        parseFloat(r[4]),
      ytdBench:   (r[5] !== '' && r[5] != null && !isNaN(r[5])) ? parseFloat(r[5]) : null,
    });
  }
  return out;
}

function parseHoldings(rows) {
  const portfolios = [];
  let name = null, holdings = [], total = null;
  for (let i = 0; i < rows.length; i++) {
    const r = rows[i];
    const first = String(r[0] || '').trim();
    if (first && (r[1] === '' || r[1] == null || isNaN(r[1])) && first !== 'Ticker') {
      if (name && holdings.length) portfolios.push({ name, holdings, total });
      name = first; holdings = []; total = null;
      continue;
    }
    if (first === 'Ticker') continue;
    if (!first && parseFloat(r[1]) === 1) {
      total = { totalReturn: parseFloat(r[3])||0, bench: (r[4] !== '' && !isNaN(r[4])) ? parseFloat(r[4]) : null };
      continue;
    }
    if (first && first !== 'NaN' && first !== '') {
      holdings.push({ ticker: first, weight: parseFloat(r[1])||0, ret: parseFloat(r[2])||0, contrib: parseFloat(r[3])||0 });
    }
  }
  if (name && holdings.length) portfolios.push({ name, holdings, total });
  return portfolios;
}

// â”€â”€ RENDER BENCHMARKS FROM LIVE PRICES â”€â”€
function renderBenchSection() {
  const row = document.getElementById('bench-cards');
  row.innerHTML = '';
  BENCHMARKS.forEach(b => {
    const price = liveprices[b.ticker];
    const daily = price ? price.daily : null;
    const div = document.createElement('div');
    div.className = `card bench ${daily > 0 ? 'positive' : daily < 0 ? 'negative' : ''}`;
    div.innerHTML = `
      <div class="card-accent"></div>
      <div class="card-label">${b.name}</div>
      <div class="card-value ${cc(daily)}">${fmt(daily)}</div>
      <div class="card-type">Daily Return Â· ${b.ticker}</div>`;
    row.appendChild(div);
  });
}

// â”€â”€ COMBINED CHART (benchmarks live + models from upload) â”€â”€
function renderChartCombined() {
  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }

  const benchEntries = BENCHMARKS.map(b => ({
    model: b.name,
    daily: liveprices[b.ticker]?.daily ?? 0,
    ytd:   0,
    isBench: true
  }));
  const modelEntries = modelData.map(d => ({ ...d, isBench: false }));
  const data = [...benchEntries, ...modelEntries];

  const labels = data.map(d => d.model);
  const daily  = data.map(d => +(d.daily * 100).toFixed(2));
  const ytd    = data.map(d => d.ytd != null ? +(d.ytd * 100).toFixed(2) : null);
  const colors = data.map(d =>
    d.isBench
      ? (d.daily >= 0 ? 'rgba(64,145,108,0.8)'  : 'rgba(184,50,50,0.65)')
      : (d.daily >= 0 ? 'rgba(27,67,50,0.85)'   : 'rgba(184,50,50,0.65)')
  );

  chartInstance = new Chart(document.getElementById('perf-chart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Daily %', data: daily, backgroundColor: colors, borderRadius: 4, barPercentage: 0.6, yAxisID: 'y' },
        { label: 'YTD %', data: ytd, type: 'line', tension: 0.35, fill: false,
          borderColor: 'rgba(201,168,76,0.95)', borderWidth: 2.5,
          pointBackgroundColor: '#c9a84c', pointBorderColor: '#fff', pointBorderWidth: 2,
          pointRadius: 6, pointHoverRadius: 8, yAxisID: 'y2',
          spanGaps: false }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#3d5240', font: { family: 'Source Sans 3', size: 13 }, padding: 20 } },
        tooltip: {
          backgroundColor: '#1b4332', borderColor: '#c9a84c', borderWidth: 1,
          titleColor: '#fff', titleFont: { family: 'Source Sans 3', size: 13 },
          bodyColor: '#d8f3dc', bodyFont: { family: 'Source Sans 3', size: 13 }, padding: 12,
          callbacks: { label: c => ` ${c.dataset.label}: ${c.parsed.y != null ? (c.parsed.y > 0 ? '+' : '') + c.parsed.y.toFixed(2) + '%' : 'â€”'}` }
        }
      },
      scales: {
        x:  { ticks: { color: '#7a917e', font: { family: 'Source Sans 3', size: 12 } }, grid: { color: '#eef0eb' } },
        y:  { ticks: { color: '#7a917e', font: { family: 'Source Sans 3', size: 12 }, callback: v => v.toFixed(2)+'%' }, grid: { color: '#eef0eb' } },
        y2: { position: 'right', ticks: { color: 'rgba(201,168,76,0.85)', font: { family: 'Source Sans 3', size: 12 }, callback: v => v.toFixed(2)+'%' }, grid: { display: false } }
      }
    }
  });
}

function renderModelCards(data) {
  const row = document.getElementById('model-cards');
  row.innerHTML = '';
  if (!data || data.length === 0) {
    row.innerHTML = `<div style="grid-column:1/-1;background:var(--white);border:2px dashed var(--border);border-radius:6px;padding:28px;text-align:center;color:var(--text-light);font-size:0.9rem;">
      <div style="font-size:1.6rem;margin-bottom:8px">ðŸ“‚</div>
      <div style="font-weight:700;color:var(--text-mid);margin-bottom:4px">Upload Excel to see Portfolio Models</div>
      Use the <strong>Upload Model Data</strong> button above to load YTD performance and holdings.
    </div>`;
    return;
  }
  data.forEach(d => {
    const div = document.createElement('div');
    div.className = `card ${d.daily > 0 ? 'positive' : d.daily < 0 ? 'negative' : ''}`;
    div.innerHTML = `
      <div class="card-accent"></div>
      <div class="card-label">${d.model}</div>
      <div class="card-value ${cc(d.daily)}">${fmt(d.daily)}</div>
      <div class="card-type">Daily Return</div>
      <div class="card-divider"></div>
      ${d.dailyBench !== null ? `<div class="card-row"><span>vs Benchmark</span><span class="val ${cc(d.dailyBench)}">${fmt(d.dailyBench)}</span></div>` : ''}
      <div class="card-row"><span>YTD</span><span class="val ${cc(d.ytd)}">${fmt(d.ytd)}</span></div>
      ${d.ytdBench !== null ? `<div class="card-row"><span>YTD vs Bench</span><span class="val ${cc(d.ytdBench)}">${fmt(d.ytdBench)}</span></div>` : ''}`;
    row.appendChild(div);
  });
}


let allPortfolios = [];

function renderHoldings(portfolios) {
  allPortfolios = portfolios;
  const select = document.getElementById('holdings-select');
  select.innerHTML = '<option value="">â€” Select a portfolio â€”</option>';
  portfolios.forEach((p, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = p.name;
    select.appendChild(opt);
  });
  if (portfolios.length > 0) {
    select.value = '0';
    showSelectedPortfolio();
  } else {
    document.getElementById('holdings-panels').innerHTML = '';
  }
}

function showSelectedPortfolio() {
  const select = document.getElementById('holdings-select');
  const container = document.getElementById('holdings-panels');
  const idx = select.value;
  if (idx === '' || !allPortfolios[idx]) {
    container.innerHTML = '';
    return;
  }
  const p = allPortfolios[idx];
  const total = p.total;
  const rc = total ? cc(total.totalReturn) : 'neu';
  const rl = total ? fmt(total.totalReturn) : 'â€”';
  let rows = '';
  p.holdings.forEach(h => {
    rows += `<tr>
      <td><span class="ticker-tag">${h.ticker}</span></td>
      <td>${(h.weight*100).toFixed(1)}%</td>
      <td class="${cc(h.ret)}">${fmt(h.ret)}</td>
      <td class="${cc(h.contrib)}">${fmt(h.contrib)}</td>
    </tr>`;
  });
  if (total) {
    rows += `<tr class="total-row">
      <td>Portfolio Total</td><td></td><td></td>
      <td class="${cc(total.totalReturn)}">${fmt(total.totalReturn)}</td>
    </tr>`;
  }
  const benchStr = total?.bench != null
    ? `<span class="panel-bench" style="margin-left:10px">vs bench <span class="${cc(total.bench)}">${fmt(total.bench)}</span></span>` : '';
  container.innerHTML = '';
  const wrap = document.createElement('div');
  wrap.className = 'holdings-panel-wrap';
  wrap.innerHTML = `
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">${p.name}</span>
        <div style="display:flex;align-items:center;gap:10px">
          <span class="panel-return ${rc}">${rl}</span>${benchStr}
        </div>
      </div>
      <table>
        <thead><tr><th>Ticker</th><th>Weight</th><th>Return</th><th>Contribution</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
  container.appendChild(wrap);
}
</script>
</body>
</html>
